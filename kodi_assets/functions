#! /opt/bin/bash
# c plgroves gmail 2022
# pia-foss-wireguard kodi functions
  # credentials for local kodi
    kodi_user=kodi
    kodi_pass=
    kodi_host=localhost
    kodi_port=8080

  function _parse_JSON {
      local key=$1
      /usr/bin/awk -F"[,:}]" \
                   '{for(i=1;i<=NF;i++)
                    {if($i~/'"${key}"'\042/)
                       {print $(i+1)}}}' \
                 | tr -d '"'
 }
 export -f _parse_JSON

  function _kodi_REQ {
      /opt/bin/curl --silent -X POST --header "Content-Type: application/json" -d "$1" http://$kodi_user:$kodi_pass@$kodi_host:$kodi_port/jsonrpc
 }
 export -f _kodi_REQ

# ALL that to get to this
  function _pia_notify() {
      local message displaytime image show_image
            message="${1:-message is empty}"
            displaytime="${2:-5000}"
            image="${3:-"kodi_assets/pia_on_48x48.png"}"
            [[ -s "$(pwd)/${image}" ]] \
            && showimage=',"image":"'"$(pwd)/${image}"'"'

      status="$( _parse_JSON 'result' < <(_kodi_REQ ' {"jsonrpc": "2.0", "method": "GUI.ShowNotification", "params": {"title": "PIA Wireguard Connection", "message": "'"${message}"'" , "displaytime": '"${displaytime}"''"${showimage}"' }, "id": 1} '))"

      if  [[ "$status" =~ OK ]]
      then return 0
      else return 1
      fi
 }
  export -f _pia_notify
